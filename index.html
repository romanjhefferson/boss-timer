<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Lordnine Boss Monitoring</title>

<style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; transition: background 0.3s, color 0.3s; }
    header { display: flex; align-items: center; padding: 0.8rem 1rem; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    #respawnBanner { flex: 1; text-align: center; }
    #nextRespawn { font-weight: bold; font-size: 1.1rem; transition: color 0.3s, text-shadow 0.3s; }

    #factionFilter {
      margin-right: 0.5rem;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      border: 1px solid;
      font-size: 0.9rem;
    }

    #themeToggle { 
      background: none; 
      border: 1px solid; 
      border-radius: 6px; 
      padding: 0.3rem 0.8rem;
      cursor: pointer; 
      font-size: 1.1rem;
    }

    table { width: 100%; border-collapse: collapse; margin: 1rem 0; border-radius: 8px; overflow: hidden; }
    th, td { padding: 0.75rem; text-align: left; font-size: 0.95rem; }
    tr:last-child td { border-bottom: none; }
    h3 { margin-top: 1.5rem; margin-left: 1rem; }
    th { position: sticky; top: 3.1rem; z-index: 5; } /* under header */
    .row-alive { background: rgba(119, 221, 119, 0.25); }
    .highlight-today { border: 2px solid; box-shadow: 0 0 10px; }
    .separator { text-align: center; font-weight: bold; margin: 2rem 0 1rem; padding: 0.5rem; border-top: 2px solid #ccc; border-bottom: 2px solid #ccc; font-size: 1rem; opacity: 0.8; }

    body.dark { background: #2c2c2c; color: #e0e0e0; }
    body.dark header { background: #111; color: white; }
    body.dark table { background: #3a3a3a; }
    body.dark th { background: #444; color: #f0f0f0; }
    body.dark td { border-bottom: 1px solid #555; }
    body.dark .highlight-today { border-color: #b366ff; box-shadow: 0 0 10px rgba(179,102,255,0.7); }
    body.dark .separator { border-color: #777; color: #ddd; }

    body.light { background: #f5f5f5; color: #222; }
    body.light header { background: #fff; color: #222; }
    body.light table { background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
    body.light th { background: #f0f0f0; color: #222; }
    body.light td { border-bottom: 1px solid #ddd; }
    body.light .highlight-today { border-color: #ffcc66; box-shadow: 0 0 10px rgba(255, 204, 102, 0.7); }
    body.light .separator { border-color: #bbb; color: #333; }
</style>
</head>
<body>
<header>
  <div id="respawnBanner">
    <span id="nextRespawn">Loading...</span>
  </div>
  <select id="factionFilter">
    <option value="All">All</option>
    <option value="BloodMoon">BloodMoon</option>
    <option value="Alliance">Alliance</option>
  </select>
  <button id="themeToggle">ðŸŒ™</button>
</header>

<!-- FIXED RESPAWNS TODAY â€“ ALWAYS ON TOP -->
<h3 id="fixedSoonHeader" style="display:none;">âš¡ Fixed Respawns Today</h3>
<table class="highlight-today" id="fixedSoon" style="display:none;">
  <thead>
    <tr><th>Boss</th><th>Status</th><th>Respawn Time</th><th>Countdown</th></tr>
  </thead>
  <tbody></tbody>
</table>

<!-- DYNAMIC RESPAWNS BELOW FIXED TODAY -->
<h3 id="dynamicHeader">Dynamic Respawns</h3>
<table id="upcoming">
  <thead>
    <tr><th>Boss</th><th>Status</th><th>Respawn Time</th><th>Countdown</th></tr>
  </thead>
  <tbody></tbody>
</table>

<!-- OTHER FIXED RESPAWNS AT THE BOTTOM -->
<div class="separator" id="separator" style="display:none;">â”€â”€â”€â”€ Other Fixed Respawns â”€â”€â”€â”€</div>
<table id="fixed">
  <thead>
    <tr><th>Boss</th><th>Status</th><th>Respawn Time</th><th>Countdown</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const sheetURL = "https://opensheet.elk.sh/1RoupDDa_fQdcowVCNpL2q1mJDDAw3obvIwRQhOp7Z5E/Sheet1";

/* Alliance list (now includes Venatus, Viorent) */
const allianceBosses = new Set([
  "Ego","Clemantis","Livera","Araneo","Undomiel","Saphirus",
  "Neutro","Lady Dalia","General Aquleus","Thymele","Amentis",
  "Baron Braudmore","Venatus","Viorent"
]);

/* Display name helper for (Alliance) suffix */
function displayName(boss) {
  return allianceBosses.has(boss) ? `${boss} (Alliance)` : boss;
}

/* Filter mode: All / BloodMoon / Alliance */
let filterMode = localStorage.getItem("filterMode") || "All";
const factionFilter = document.getElementById("factionFilter");
factionFilter.value = filterMode;

factionFilter.addEventListener("change", () => {
  filterMode = factionFilter.value;
  localStorage.setItem("filterMode", filterMode);
  render();
});

function passesFilter(boss) {
  const isAlliance = allianceBosses.has(boss);
  if (filterMode === "All") return true;
  if (filterMode === "Alliance") return isAlliance;
  if (filterMode === "BloodMoon") return !isAlliance;
  return true;
}

/* Dynamic respawn timers */
const respawnTimes = { 
  "Venatus": 10, "Viorent": 10, "Araneo": 24, "Undomiel": 24,
  "Lady Dalia": 18, "Amentis": 29, "Ego": 21, "Livera": 24,
  "General Aquleus": 29, "Baron Braudmore": 32, "Wannitas": 48,
  "Metus": 48, "Duplican": 48, "Shuliar": 35, "Gareth": 32,
  "Titore": 37, "Larba": 35, "Catena": 35,
  "Secreta": 62, "Ordo": 62, "Asta": 62, "Supore": 62
};

/* Fixed schedules (plus Icaruthia, Motti, Nevaea) */
const fixedSchedules = {
  "Clemantis": [ { day: 1, hour: 11, minute: 30 }, { day: 4, hour: 19, minute: 0 } ],
  "Saphirus":  [ { day: 2, hour: 11, minute: 30 }, { day: 0, hour: 17, minute: 0 } ],
  "Neutro":    [ { day: 2, hour: 19, minute: 0 }, { day: 4, hour: 11, minute: 30 } ],
  "Milavy":    [ { day: 6, hour: 15, minute: 0 } ],
  "Ringor":    [ { day: 6, hour: 17, minute: 0 } ],
  "Roderick":  [ { day: 5, hour: 19, minute: 0 } ],
  "Thymele":   [ { day: 1, hour: 19, minute: 0 }, { day: 3, hour: 11, minute: 30 } ],
  "Auraq":     [ { day: 3, hour: 21, minute: 0 }, { day: 5, hour: 22, minute: 0 } ],
  "Chaiflock": [ { day: 6, hour: 22, minute: 0 } ],
  "Benji":     [ { day: 0, hour: 21, minute: 0 } ],

  "Icaruthia": [
    { day: 2, hour: 21, minute: 0 }, { day: 5, hour: 21, minute: 0 }
  ],
  "Motti": [
    { day: 3, hour: 19, minute: 0 }, { day: 6, hour: 19, minute: 0 }
  ],
  "Nevaea": [
    { day: 0, hour: 22, minute: 0 }
  ]
};

function formatDate(date) {
  const o = { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true };
  return date.toLocaleString('en-US', o);
}
function formatDateWithWeekday(date) {
  const weekday = date.toLocaleDateString('en-US', { weekday: 'long' });
  return `${formatDate(date)} (${weekday})`;
}
function formatCountdown(target) {
  const now = new Date();
  const diff = target - now;
  if (diff <= 0) return "Now!";
  const h = Math.floor(diff / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  const s = Math.floor((diff % 60000) / 1000);
  return `${h}h ${m}m ${s}s`;
}

async function fetchData() {
  const res = await fetch(sheetURL);
  window.bossData = await res.json();
  render();
}

let countdownInterval;

function render() {
  const data = window.bossData || [];
  const now = new Date();
  let upcoming = [];
  let fixedUpcoming = [];

  /* Dynamic bosses from sheet */
  data.forEach(row => {
    const boss = row.Boss ? row.Boss.trim() : "";
    if (!boss) return;
    if (!passesFilter(boss)) return;

    const death = new Date(row.DeathTime);
    const hours = respawnTimes[boss];
    if (!hours || isNaN(death)) return;
    const respawn = new Date(death.getTime() + hours * 3600000);
    upcoming.push({ boss, respawn });
  });

  /* Fixed bosses */
  Object.entries(fixedSchedules).forEach(([boss, schedules]) => {
    if (!passesFilter(boss)) return;
    schedules.forEach(s => {
      const respawn = new Date(now);
      respawn.setDate(now.getDate() + ((s.day - now.getDay() + 7) % 7));
      respawn.setHours(s.hour, s.minute, 0, 0);
      if (respawn < now) respawn.setDate(respawn.getDate() + 7);
      fixedUpcoming.push({ boss, respawn });
    });
  });

  upcoming.sort((a,b) => a.respawn - b.respawn);
  fixedUpcoming.sort((a,b) => a.respawn - b.respawn);

  /* Dynamic table with fixed status logic */
  document.querySelector("#upcoming tbody").innerHTML = upcoming.map(r => {
    let diff = r.respawn - now;
    let hours = diff / 3600000;
    let statusText = "";
    if (diff <= 0) statusText = "ðŸŸ¢ Alive";
    else if (hours < 1) statusText = "ðŸ”´ Very Soon";
    else if (hours < 6) statusText = "ðŸŸ¡ Soon";
    else if (r.respawn.toDateString() === now.toDateString()) statusText = "â³ Today";
    else if (r.respawn.toDateString() === new Date(now.getTime() + 86400000).toDateString()) statusText = "ðŸ“… Tomorrow";
    else statusText = "ðŸ“Œ Scheduled";

    return `
      <tr>
        <td>${displayName(r.boss)}</td>
        <td>${statusText}</td>
        <td>${formatDateWithWeekday(r.respawn)}</td>
        <td class="countdown" data-time="${r.respawn}">${formatCountdown(r.respawn)}</td>
      </tr>`;
  }).join("");

  /* Fixed: split into "today" vs later */
  const soonFixed = fixedUpcoming.filter(r => r.respawn.toDateString() === now.toDateString());
  const laterFixed = fixedUpcoming.filter(r => r.respawn.toDateString() !== now.toDateString());

  document.querySelector("#fixedSoon tbody").innerHTML =
    soonFixed.map(r =>
      `<tr><td>${displayName(r.boss)}</td><td>âš¡ Today</td><td>${formatDateWithWeekday(r.respawn)}</td><td class="countdown" data-time="${r.respawn}">${formatCountdown(r.respawn)}</td></tr>`
    ).join("");

  document.querySelector("#fixed tbody").innerHTML =
    laterFixed.map(r =>
      `<tr><td>${displayName(r.boss)}</td><td>Scheduled</td><td>${formatDateWithWeekday(r.respawn)}</td><td class="countdown" data-time="${r.respawn}">${formatCountdown(r.respawn)}</td></tr>`
    ).join("");

  document.getElementById("fixedSoonHeader").style.display = soonFixed.length ? "block" : "none";
  document.getElementById("fixedSoon").style.display = soonFixed.length ? "table" : "none";
  document.getElementById("separator").style.display = laterFixed.length ? "block" : "none";

  /* Banner */
  const allRespawns = [...upcoming, ...fixedUpcoming];
  const banner = document.getElementById("nextRespawn");

  if (allRespawns.length > 0) {
    const next = allRespawns.sort((a,b) => a.respawn - b.respawn)[0];

    function rebanner() {
      banner.textContent = `${displayName(next.boss)} respawns in ${formatCountdown(next.respawn)} at ${formatDateWithWeekday(next.respawn)}`;
      document.querySelectorAll(".countdown").forEach(td => {
        const t = new Date(td.dataset.time);
        td.textContent = formatCountdown(t);
      });
    }
    if (countdownInterval) clearInterval(countdownInterval);
    rebanner();
    countdownInterval = setInterval(rebanner, 1000);
  } else {
    banner.textContent = "No upcoming respawns (check filter).";
    if (countdownInterval) clearInterval(countdownInterval);
  }
}

fetchData();
setInterval(render, 60000);

/* THEME TOGGLE */
const themeToggleBtn = document.getElementById("themeToggle");
function setTheme(theme) {
  document.body.classList.remove("light","dark");
  document.body.classList.add(theme);
  localStorage.setItem("theme", theme);
  themeToggleBtn.textContent = theme === "dark" ? "ðŸŒ™" : "â˜€ï¸";
}
setTheme(localStorage.getItem("theme") || "dark");
themeToggleBtn.addEventListener("click", () => {
  setTheme(document.body.classList.contains("dark") ? "light" : "dark");
});
</script>
</body>
</html>
