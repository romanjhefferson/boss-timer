<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BloodMoon & Alliance Boss Timers</title>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    transition: background .3s, color .3s;
  }
  header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: .8rem;
    padding: .8rem 1rem;
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 2px 6px rgba(0,0,0,.2);
  }
  #factionFilter {
    padding: .3rem .6rem;
    border-radius: 4px;
    font-size: .9rem;
  }
  #themeToggle {
    background: none;
    border: 1px solid;
    border-radius: 6px;
    padding: .3rem .8rem;
    cursor: pointer;
    font-size: 1.1rem;
  }

  main {
    padding: .5rem .5rem 2rem;
    max-width: 1000px;
    margin: 0 auto;
  }

  h3 {
    margin-top: 1.5rem;
    margin-bottom: .5rem;
  }

  .table-wrapper {
    width: 100%;
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin: .3rem 0 1rem;
    border-radius: 8px;
    overflow: hidden;
    min-width: 480px;
  }
  th, td {
    padding: .6rem .75rem;
    text-align: left;
    font-size: .9rem;
    white-space: nowrap;
  }
  th {
    position: sticky;
    top: 3.1rem;
    z-index: 5;
  }
  td {
    border-bottom: 1px solid rgba(0,0,0,.2);
  }

  .highlight-today {
    border: 2px solid;
    box-shadow: 0 0 8px rgba(0,0,0,.35);
  }

  .separator {
    text-align: center;
    font-weight: bold;
    margin: 1.5rem 0 .7rem;
    padding: .4rem;
    border-top: 2px solid #ccc;
    border-bottom: 2px solid #ccc;
    opacity: .85;
  }

  body.dark {
    background:#2c2c2c;
    color:#e0e0e0;
  }
  body.dark header { background:#111; }
  body.dark main { color:#e0e0e0; }
  body.dark table { background:#3a3a3a; }
  body.dark th { background:#444; }
  body.dark td { border-bottom:1px solid #555; }
  body.dark .separator { border-color:#777; color:#ddd; }

  body.light {
    background:#f5f5f5;
    color:#222;
  }
  body.light header { background:#fff; }
  body.light table { background:white; box-shadow:0 2px 6px rgba(0,0,0,.20); }
  body.light th { background:#f0f0f0; }
  body.light td { border-bottom:1px solid #ddd; }
  body.light .separator { border-color:#bbb; color:#333; }

  @media(max-width:600px){
    header {
      flex-direction: column;
      gap: .55rem;
    }
    #factionFilter, #themeToggle {
      width: 70%;
      font-size: .9rem;
    }
    table {
      min-width: 420px;
    }
  }
</style>
</head>
<body>

<header>
  <select id="factionFilter">
    <option value="All">All</option>
    <option value="Alliance">Alliance</option>
    <option value="BloodMoon">BloodMoon</option>
  </select>
  <button id="themeToggle">ðŸŒ™</button>
</header>

<main>
  <h3>âš¡ Fixed Respawns Today</h3>
  <div class="table-wrapper">
    <table class="highlight-today" id="fixedToday">
      <thead>
        <tr>
          <th>Boss</th>
          <th>Status</th>
          <th>Respawn Time</th>
          <th>Countdown</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h3>Dynamic Respawns</h3>
  <div class="table-wrapper">
    <table id="dynamicTable">
      <thead>
        <tr>
          <th>Boss</th>
          <th>Status</th>
          <th>Respawn Time</th>
          <th>Countdown</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="separator" id="fixedSeparator" style="display:none;">â”€â”€â”€â”€ Other Fixed Respawns â”€â”€â”€â”€</div>

  <div class="table-wrapper">
    <table id="fixedOther">
      <thead>
        <tr>
          <th>Boss</th>
          <th>Status</th>
          <th>Respawn Time</th>
          <th>Countdown</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script>
  const sheetURL = "https://opensheet.elk.sh/1RoupDDa_fQdcowVCNpL2q1mJDDAw3obvIwRQhOp7Z5E/Sheet1";

  // --- helpers ---
  function normalizeBossName(name){
    return String(name || "")
      .normalize("NFKC")
      .replace(/[\u200B-\u200D\uFEFF]/g, "")
      .replace(/\s+/g, " ")
      .trim()
      .toLowerCase();
  }

  // Boss configuration
  const bossConfigs = {
    // Alliance dynamic
    "venatus": { name:"Venatus", factions:["Alliance"], type:"dynamic", respawnHours:10 },
    "viorent": { name:"Viorent", factions:["Alliance"], type:"dynamic", respawnHours:10 },
    "ego": { name:"Ego", factions:["Alliance"], type:"dynamic", respawnHours:21 },
    "livera": { name:"Livera", factions:["Alliance"], type:"dynamic", respawnHours:24 },
    "araneo": { name:"Araneo", factions:["Alliance"], type:"dynamic", respawnHours:24 },
    "undomiel": { name:"Undomiel", factions:["Alliance"], type:"dynamic", respawnHours:24 },
    "lady dalia": { name:"Lady Dalia", factions:["Alliance"], type:"dynamic", respawnHours:18 },
    "general aquleus": { name:"General Aquleus", factions:["Alliance"], type:"dynamic", respawnHours:29 },
    "amentis": { name:"Amentis", factions:["Alliance"], type:"dynamic", respawnHours:29 },
    "baron braudmore": { name:"Baron Braudmore", factions:["Alliance"], type:"dynamic", respawnHours:32 },

    // Alliance fixed
    "clemantis": {
      name:"Clemantis", factions:["Alliance"], type:"fixed",
      schedules:[
        { day:1, hour:11, minute:30 }, // Monday 11:30
        { day:4, hour:19, minute:0 }   // Thursday 19:00
      ]
    },
    "saphirus": {
      name:"Saphirus", factions:["Alliance"], type:"fixed",
      schedules:[
        { day:0, hour:17, minute:0 },  // Sunday 17:00
        { day:2, hour:11, minute:30 }  // Tuesday 11:30
      ]
    },
    "neutro": {
      name:"Neutro", factions:["Alliance"], type:"fixed",
      schedules:[
        { day:2, hour:19, minute:0 },  // Tuesday 19:00
        { day:4, hour:11, minute:30 }  // Thursday 11:30
      ]
    },
    "thymele": {
      name:"Thymele", factions:["Alliance"], type:"fixed",
      schedules:[
        { day:1, hour:19, minute:0 },  // Monday 19:00
        { day:3, hour:11, minute:30 }  // Wednesday 11:30
      ]
    },

    // BloodMoon dynamic
    "wannitas": { name:"Wannitas", factions:["BloodMoon"], type:"dynamic", respawnHours:48 },
    "metus": { name:"Metus", factions:["BloodMoon"], type:"dynamic", respawnHours:48 },
    "duplican": { name:"Duplican", factions:["BloodMoon"], type:"dynamic", respawnHours:48 },
    "shuliar": { name:"Shuliar", factions:["BloodMoon"], type:"dynamic", respawnHours:35 },
    "gareth": { name:"Gareth", factions:["BloodMoon"], type:"dynamic", respawnHours:32 },
    "titore": { name:"Titore", factions:["BloodMoon"], type:"dynamic", respawnHours:37 },
    "larba": { name:"Larba", factions:["BloodMoon"], type:"dynamic", respawnHours:35 },
    "catena": { name:"Catena", factions:["BloodMoon"], type:"dynamic", respawnHours:35 },
    "secreta": { name:"Secreta", factions:["BloodMoon"], type:"dynamic", respawnHours:62 },
    "ordo": { name:"Ordo", factions:["BloodMoon"], type:"dynamic", respawnHours:62 },
    "asta": { name:"Asta", factions:["BloodMoon"], type:"dynamic", respawnHours:62 },
    "supore": { name:"Supore", factions:["BloodMoon"], type:"dynamic", respawnHours:62 },

    // BloodMoon fixed
    "milavy": {
      name:"Milavy", factions:["BloodMoon"], type:"fixed",
      schedules:[{ day:6, hour:15, minute:0 }]   // Saturday 15:00
    },
    "ringor": {
      name:"Ringor", factions:["BloodMoon"], type:"fixed",
      schedules:[{ day:6, hour:17, minute:0 }]   // Saturday 17:00
    },
    "roderick": {
      name:"Roderick", factions:["BloodMoon"], type:"fixed",
      schedules:[{ day:5, hour:19, minute:0 }]   // Friday 19:00
    },
    "auraq": {
      name:"Auraq", factions:["BloodMoon"], type:"fixed",
      schedules:[
        { day:5, hour:22, minute:0 },  // Friday 22:00
        { day:3, hour:21, minute:0 }   // Wednesday 21:00
      ]
    },
    "chaiflock": {
      name:"Chaiflock", factions:["BloodMoon"], type:"fixed",
      schedules:[{ day:6, hour:22, minute:0 }]   // Saturday 22:00
    },
    "benji": {
      name:"Benji", factions:["BloodMoon"], type:"fixed",
      schedules:[{ day:0, hour:21, minute:0 }]   // Sunday 21:00
    },

    // Shared (Alliance + BloodMoon)
    "icaruthia": {
      name:"Icaruthia", factions:["Alliance","BloodMoon"], type:"fixed",
      schedules:[
        { day:2, hour:21, minute:0 },  // Tuesday 21:00
        { day:5, hour:21, minute:0 }   // Friday 21:00
      ]
    },
    "motti": {
      name:"Motti", factions:["Alliance","BloodMoon"], type:"fixed",
      schedules:[
        { day:3, hour:19, minute:0 },  // Wednesday 19:00
        { day:6, hour:19, minute:0 }   // Saturday 19:00
      ]
    },
    "nevaeh": {
      name:"Nevaeh", factions:["Alliance","BloodMoon"], type:"fixed",
      schedules:[
        { day:0, hour:22, minute:0 }   // Sunday 22:00
      ]
    }
  };

  // Find config by sheet boss name (tolerant to extra text)
  function findBossConfig(sheetName){
    const cleaned = normalizeBossName(sheetName);
    let exact = null;
    let partial = null;

    for (const cfg of Object.values(bossConfigs)){
      const cfgNorm = normalizeBossName(cfg.name);
      if (!cfgNorm) continue;
      if (cleaned === cfgNorm){
        exact = cfg;
        break;
      }
      if (cleaned.includes(cfgNorm)){
        if (!partial || cfgNorm.length > normalizeBossName(partial.name).length){
          partial = cfg;
        }
      }
    }
    return exact || partial || null;
  }

  // Filter state
  let filterMode = localStorage.getItem("filterMode") || "All";
  const factionFilterEl = document.getElementById("factionFilter");
  factionFilterEl.value = filterMode;
  factionFilterEl.addEventListener("change", e=>{
    filterMode = e.target.value;
    localStorage.setItem("filterMode", filterMode);
    render();
  });

  function passesFilter(cfg){
    if (!cfg) return false;
    if (filterMode === "All") return true;
    return cfg.factions && cfg.factions.includes(filterMode);
  }

  // Date helpers
  function parseDeathTime(str){
    const m = String(str || "").trim().match(/(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{1,2}):(\d{1,2})/);
    if (!m) return new Date(NaN);
    const [, MM, DD, YYYY, hh, mm] = m.map(Number);
    return new Date(YYYY, MM-1, DD, hh, mm);
  }

  function formatDatePH(d){
    return d.toLocaleString("en-US", {
      timeZone: "Asia/Manila",
      month: "short",
      day: "numeric",
      hour: "numeric",
      minute: "2-digit",
      hour12: true
    });
  }

  function formatDateWithWeekdayPH(d){
    const main = formatDatePH(d);
    const weekday = d.toLocaleDateString("en-US", {
      timeZone: "Asia/Manila",
      weekday: "long"
    });
    return `${main} (${weekday})`;
  }

  function formatCountdown(target){
    const now = new Date();
    const diff = target - now;
    if (diff <= 0) return "Now!";
    const totalSec = Math.floor(diff / 1000);
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    const s = totalSec % 60;
    return `${h}h ${m}m ${s}s`;
  }

  // Fixed respawn next occurrence
  function getNextWeeklyOccurrence(day, hour, minute, now){
    const result = new Date(now);
    result.setSeconds(0,0);
    result.setHours(hour, minute, 0, 0);

    const currentDow = now.getDay();
    let diff = (day - currentDow + 7) % 7;

    if (diff === 0){
      // same weekday
      if (result <= now){
        diff = 7;     // already passed today -> next week
      } else {
        diff = 0;     // later today -> keep today
      }
    }

    result.setDate(now.getDate() + diff);
    return result;
  }

  let bossRows = [];
  let countdownTimer = null;

  async function fetchSheet(){
    try {
      const res = await fetch(sheetURL);
      bossRows = await res.json();
    } catch (e){
      console.error("Error fetching sheet:", e);
      bossRows = [];
    }
    render();
  }

  // Build dynamic list
  function buildDynamicRespawns(now){
    const latestDeaths = {};

    bossRows.forEach(row=>{
      const cfg = findBossConfig(row.Boss);
      if (!cfg || cfg.type !== "dynamic") return;
      if (!row.DeathTime) return;

      const death = parseDeathTime(row.DeathTime);
      if (isNaN(death)) return;

      const key = normalizeBossName(cfg.name);
      if (!latestDeaths[key] || death > latestDeaths[key]){
        latestDeaths[key] = death;
      }
    });

    const list = [];
    Object.entries(latestDeaths).forEach(([key, death])=>{
      const cfg = bossConfigs[key];
      if (!cfg || cfg.type !== "dynamic") return;
      const respawn = new Date(death.getTime() + cfg.respawnHours * 3600000);
      list.push({ key, cfg, respawn });
    });
    return list;
  }

  // Build fixed list
  function buildFixedRespawns(now){
    const fixed = [];
    Object.entries(bossConfigs).forEach(([key, cfg])=>{
      if (!cfg || cfg.type !== "fixed" || !
