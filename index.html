<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Lordnine Boss Monitoring</title>

<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; transition: background 0.3s, color 0.3s; }
  header { display: flex; align-items: center; padding: 0.8rem 1rem; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
  #respawnBanner { flex: 1; text-align: center; }
  #nextRespawn { font-weight: bold; font-size: 1.1rem; }

  #factionFilter {
    margin-right: 0.5rem;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    border: 1px solid;
    font-size: 0.9rem;
  }

  #themeToggle {
    background: none;
    border: 1px solid;
    border-radius: 6px;
    padding: 0.3rem 0.8rem;
    cursor: pointer;
    font-size: 1.1rem;
  }

  table { width: 100%; border-collapse: collapse; margin: 1rem 0; border-radius: 8px; overflow: hidden; }
  th, td { padding: 0.75rem; text-align: left; font-size: 0.95rem; }
  th { position: sticky; top: 3.1rem; z-index: 5; }

  .highlight-today { border: 2px solid; box-shadow: 0 0 10px; }
  .separator { text-align: center; font-weight: bold; margin: 2rem 0 1rem; padding: 0.5rem; border-top: 2px solid #ccc; border-bottom: 2px solid #ccc; font-size: 1rem; opacity: 0.8; }

  .countdown { font-weight: 500; transition: color 0.3s; }
  .countdown-soon { color: #f1c40f; }
  .countdown-very-soon { color: #e74c3c; }

  .next-respawn-row td { font-weight: 600; }

  .banner-boss,
  .banner-countdown { font-weight: 700; transition: color 0.35s, text-shadow 0.35s; }
  .banner-boss.soon,
  .banner-countdown.soon { color: #f1c40f; }
  .banner-boss.very-soon,
  .banner-countdown.very-soon {
    color: #e74c3c;
    text-shadow: 0 0 6px rgba(231,76,60,0.65);
    font-weight: 800;
  }

  .alive-fixed td {
    font-weight: 700;
    color: #4cff4c;
    text-shadow: 0 0 7px rgba(0,255,0,0.6);
  }

  body.dark { background: #2c2c2c; color: #e0e0e0; }
  body.dark header { background: #111; }
  body.dark table { background: #3a3a3a; }
  body.dark th { background: #444; color: #f0f0f0; }
  body.dark td { border-bottom: 1px solid #555; }
  body.dark .highlight-today { border-color: #b366ff; box-shadow: 0 0 10px rgba(179,102,255,0.7); }
  body.dark .separator { border-color: #777; color: #ddd; }
  body.dark .next-respawn-row { background: rgba(255,255,255,0.06); }

  body.light { background: #f5f5f5; color: #222; }
  body.light header { background: #fff; color: #222; }
  body.light table { background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
  body.light th { background: #f0f0f0; color: #222; }
  body.light td { border-bottom: 1px solid #ddd; }
  body.light .highlight-today { border-color: #ffcc66; box-shadow: 0 0 10px rgba(255,204,102,0.7); }
  body.light .separator { border-color: #bbb; color: #333; }
  body.light .next-respawn-row { background: rgba(255,204,102,0.18); }

  @media (max-width: 600px) {
    header { flex-direction: column; gap: 0.55rem; text-align: center; }
    #respawnBanner { width: 100%; padding: 0 0.4rem; }
    #nextRespawn { font-size: 1rem; line-height: 1.22rem; }
    #factionFilter, #themeToggle { width: 48%; font-size: 0.9rem; }
    table { font-size: 0.87rem; }
    th, td { padding: 0.55rem; }
    .banner-boss, .banner-countdown { font-size: 1.05rem; }
  }
</style>
</head>
<body>
<header>
  <div id="respawnBanner"><span id="nextRespawn">Loading...</span></div>
  <select id="factionFilter">
    <option value="All">All</option>
    <option value="BloodMoon">BloodMoon</option>
    <option value="Alliance">Alliance</option>
  </select>
  <button id="themeToggle">ðŸŒ™</button>
</header>

<h3 id="fixedSoonHeader" style="display:none;">âš¡ Fixed Respawns Today</h3>
<table class="highlight-today" id="fixedSoon" style="display:none;">
  <thead><tr><th>Boss</th><th>Status</th><th>Respawn Time</th><th>Countdown</th></tr></thead>
  <tbody></tbody>
</table>

<h3>Dynamic Respawns</h3>
<table id="upcoming">
  <thead><tr><th>Boss</th><th>Status</th><th>Respawn Time</th><th>Countdown</th></tr></thead>
  <tbody></tbody>
</table>

<div class="separator" id="separator" style="display:none;">â”€â”€â”€â”€ Other Fixed Respawns â”€â”€â”€â”€</div>
<table id="fixed">
  <thead><tr><th>Boss</th><th>Status</th><th>Respawn Time</th><th>Countdown</th></tr></thead>
  <tbody></tbody>
</table>

<script>
const sheetURL = "https://opensheet.elk.sh/1RoupDDa_fQdcowVCNpL2q1mJDDAw3obvIwRQhOp7Z5E/Sheet1";

const allianceBosses = new Set([
  "Ego","Clemantis","Livera","Araneo","Undomiel","Saphirus",
  "Neutro","Lady Dalia","General Aquleus","Thymele","Amentis",
  "Baron Braudmore","Venatus","Viorent"
]);
function displayName(boss) { return allianceBosses.has(boss) ? `${boss} (Alliance)` : boss; }

let filterMode = localStorage.getItem("filterMode") || "All";
const factionFilter = document.getElementById("factionFilter");
factionFilter.value = filterMode;

function passesFilter(boss) {
  const isAlliance = allianceBosses.has(boss);
  if (filterMode === "All") return true;
  if (filterMode === "Alliance") return isAlliance;
  if (filterMode === "BloodMoon") return !isAlliance;
  return true;
}
factionFilter.addEventListener("change", e => {
  filterMode = e.target.value;
  localStorage.setItem("filterMode", filterMode);
  render();
});

function formatDate(d) { return d.toLocaleString('en-US', { month:'short', day:'numeric', hour:'numeric', minute:'2-digit', hour12:true }); }
function formatDateWithWeekday(d) { return `${formatDate(d)} (${d.toLocaleDateString('en-US',{weekday:'long'})})`; }
function formatCountdown(t) {
  const diff = t - new Date();
  if (diff <= 0) return "Now!";
  const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
  return `${h}h ${m}m ${s}s`;
}

const respawnTimes = { 
  "Venatus": 10,"Viorent": 10,"Araneo": 24,"Undomiel": 24,
  "Lady Dalia": 18,"Amentis": 29,"Ego": 21,"Livera": 24,
  "General Aquleus": 29,"Baron Braudmore": 32,"Wannitas": 48,
  "Metus": 48,"Duplican": 48,"Shuliar": 35,"Gareth": 32,
  "Titore": 37,"Larba": 35,"Catena": 35,
  "Secreta": 62,"Ordo": 62,"Asta": 62,"Supore": 62
};

const fixedSchedules = {
  "Clemantis": [ {day:1,hour:11,minute:30}, {day:4,hour:19,minute:0} ],
  "Saphirus":  [ {day:2,hour:11,minute:30}, {day:0,hour:17,minute:0} ],
  "Neutro":    [ {day:2,hour:19,minute:0}, {day:4,hour:11,minute:30} ],
  "Milavy":    [ {day:6,hour:15,minute:0} ],
  "Ringor":    [ {day:6,hour:17,minute:0} ],
  "Roderick":  [ {day:5,hour:19,minute:0} ],
  "Thymele":   [ {day:1,hour:19,minute:0}, {day:3,hour:11,minute:30} ],
  "Auraq":     [ {day:3,hour:21,minute:0}, {day:5,hour:22,minute:0} ],
  "Chaiflock": [ {day:6,hour:22,minute:0} ],
  "Benji":     [ {day:0,hour:21,minute:0} ],
  "Icaruthia": [ {day:2,hour:21,minute:0}, {day:5,hour:21,minute:0} ],
  "Motti":     [ {day:3,hour:19,minute:0}, {day:6,hour:19,minute:0} ],
  "Nevaea":    [ {day:0,hour:22,minute:0} ]
};

let countdownInterval;

async function fetchData() {
  const res = await fetch(sheetURL);
  window.bossData = await res.json();
  render();
}

function render() {
  const now = new Date();
  const data = window.bossData || [];

  let dynamic = [];
  let fixedUpcoming = [];

  data.forEach(row => {
    const boss = row.Boss?.trim();
    if (!boss || !respawnTimes[boss] || !row.DeathTime) return;
    if (!passesFilter(boss)) return;
    const death = new Date(row.DeathTime);
    const respawn = new Date(death.getTime() + respawnTimes[boss] * 3600000);
    dynamic.push({ boss, respawn });
  });

  Object.entries(fixedSchedules).forEach(([boss, s]) => {
    if (!passesFilter(boss)) return;
    s.forEach(sc => {
      const respawn = new Date(now);
      respawn.setDate(now.getDate() + ((sc.day - now.getDay() + 7) % 7));
      respawn.setHours(sc.hour, sc.minute, 0, 0);
      if (respawn < now) respawn.setDate(respawn.getDate() + 7);
      fixedUpcoming.push({ boss, respawn });
    });
  });

  dynamic = dynamic.filter(r => !(r.boss in fixedSchedules));  // FIX that keeps Gareth in dynamic

  dynamic.sort((a,b) => a.respawn - b.respawn);
  fixedUpcoming.sort((a,b) => a.respawn - b.respawn);

  /* Dynamic table */
  document.querySelector("#upcoming tbody").innerHTML =
    dynamic.map(r => {
      const diff = r.respawn - now, h = diff / 3600000, ts = r.respawn.getTime();
      let status = diff <= 0 ? "ðŸŸ¢ Alive"
        : h < 1 ? "ðŸ”´ Very Soon"
        : h < 6 ? "ðŸŸ¡ Soon"
        : r.respawn.toDateString() === now.toDateString() ? "â³ Today"
        : r.respawn.toDateString() === new Date(now.getTime()+86400000).toDateString() ? "ðŸ“… Tomorrow"
        : "ðŸ“Œ Scheduled";
      return `<tr data-respawn-ts="${ts}">
        <td>${displayName(r.boss)}</td>
        <td>${status}</td>
        <td>${formatDateWithWeekday(r.respawn)}</td>
        <td class="countdown" data-time="${ts}">${formatCountdown(r.respawn)}</td>
      </tr>`;
    }).join("");

  /* Fixed tables */
  const todayFixed = fixedUpcoming.filter(f => f.respawn.toDateString() === now.toDateString());
  const laterFixed = fixedUpcoming.filter(f => f.respawn.toDateString() !== now.toDateString());

  document.querySelector("#fixedSoon tbody").innerHTML =
    todayFixed.map(r => {
      const diff = r.respawn - now, ts = r.respawn.getTime(), aliveClass = diff <= 0 ? "alive-fixed" : "";
      const status = diff <= 0 ? "ðŸŸ¢ Alive" : "âš¡ Today";
      return `<tr class="${aliveClass}" data-respawn-ts="${ts}">
        <td>${displayName(r.boss)}</td>
        <td>${status}</td>
        <td>${formatDateWithWeekday(r.respawn)}</td>
        <td class="countdown" data-time="${ts}">${formatCountdown(r.respawn)}</td>
      </tr>`;
    }).join("");

  document.querySelector("#fixed tbody").innerHTML =
    laterFixed.map(r => {
      const ts = r.respawn.getTime();
      return `<tr data-respawn-ts="${ts}">
        <td>${displayName(r.boss)}</td>
        <td>Scheduled</td>
        <td>${formatDateWithWeekday(r.respawn)}</td>
        <td class="countdown" data-time="${ts}">${formatCountdown(r.respawn)}</td>
      </tr>`;
    }).join("");

  document.getElementById("fixedSoonHeader").style.display = todayFixed.length ? "block" : "none";
  document.getElementById("fixedSoon").style.display = todayFixed.length ? "table" : "none";
  document.getElementById("separator").style.display = laterFixed.length ? "block" : "none";

  /* BANNER: only next dynamic respawn */
  const banner = document.getElementById("nextRespawn");
  document.querySelectorAll("#upcoming tr").forEach(tr => tr.classList.remove("next-respawn-row"));

  if (!dynamic.length) {
    banner.textContent = 'No upcoming dynamic respawns â€” see Fixed Respawns Today below.';
    if (countdownInterval) clearInterval(countdownInterval);
    return;
  }

  const nextDynamic = dynamic[0];
  const nextTs = nextDynamic.respawn.getTime().toString();
  document.querySelectorAll(`#upcoming tr[data-respawn-ts="${nextTs}"]`)
    .forEach(tr => tr.classList.add("next-respawn-row"));

  function rebanner() {
    const nowTick = new Date();
    const diff = nextDynamic.respawn - nowTick;
    const h = diff / 3600000;

    let color = "";
    if (h < 1) color = "very-soon";
    else if (h < 6) color = "soon";

    banner.innerHTML = `
      <span class="banner-boss ${color}">${displayName(nextDynamic.boss)}</span>
      respawns in
      <span class="banner-countdown ${color}">${formatCountdown(nextDynamic.respawn)}</span>
      at ${formatDateWithWeekday(nextDynamic.respawn)}
    `;

    document.querySelectorAll(".countdown").forEach(td => {
      const t = new Date(+td.dataset.time);
      td.textContent = formatCountdown(t);
      td.classList.remove("countdown-soon","countdown-very-soon");
      const d = t - nowTick;
      if (d > 0) {
        const h2 = d / 3600000;
        if (h2 < 1) td.classList.add("countdown-very-soon");
        else if (h2 < 6) td.classList.add("countdown-soon");
      }
    });
  }

  if (countdownInterval) clearInterval(countdownInterval);
  rebanner();
  countdownInterval = setInterval(rebanner, 1000);
}

/* load + periodic refresh */
fetchData();
setInterval(render, 60000);

/* theme toggle */
const themeToggleBtn = document.getElementById("themeToggle");
function setTheme(t) {
  document.body.classList.remove("light","dark");
  document.body.classList.add(t);
  localStorage.setItem("theme", t);
  themeToggleBtn.textContent = t === "dark" ? "ðŸŒ™" : "â˜€ï¸";
}
setTheme(localStorage.getItem("theme") || "dark");
themeToggleBtn.addEventListener("click", () => setTheme(document.body.classList.contains("dark") ? "light":"dark"));
</script>
</body>
</html>
